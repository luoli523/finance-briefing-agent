name: Daily Finance Briefing

on:
  # ÂÆöÊó∂ËøêË°å (cron ‰ΩøÁî® UTC Êó∂Èó¥)
  # Êñ∞Âä†Âù°Êó∂Èó¥ 09:30 = UTC 01:30
  # Âë®‰∫åÂà∞Âë®ÂÖ≠ÔºàÊñ∞Âä†Âù°Ôºâ= ÁæéËÇ°Âë®‰∏ÄÂà∞Âë®‰∫îÊî∂ÁõòÂêé
  schedule:
    - cron: '30 1 * * 2-6'  # Âë®‰∫åÂà∞Âë®ÂÖ≠ÔºåUTC 01:30 (Êñ∞Âä†Âù°Êó∂Èó¥ 09:30)

  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  generate-briefing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Python (for NotebookLM CLI)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y poppler-utils
          pip install notebooklm-py instagrapi pdf2image
          which notebooklm && notebooklm --version || echo "NotebookLM CLI verification needed"
          python3 -c "import instagrapi; print('instagrapi OK')" || echo "instagrapi verification needed"
          python3 -c "import pdf2image; print('pdf2image OK')" || echo "pdf2image verification needed"

      - name: Setup NotebookLM authentication
        env:
          NOTEBOOKLM_STORAGE_STATE: ${{ secrets.NOTEBOOKLM_STORAGE_STATE }}
        run: |
          if [ -n "$NOTEBOOKLM_STORAGE_STATE" ]; then
            mkdir -p ~/.notebooklm
            echo "$NOTEBOOKLM_STORAGE_STATE" | base64 -d > ~/.notebooklm/storage_state.json
            chmod 600 ~/.notebooklm/storage_state.json
            echo "‚úÖ NotebookLM authentication configured"
          else
            echo "‚ö†Ô∏è NotebookLM authentication not configured (secret not set)"
          fi

      - name: Setup Instagram session
        env:
          IG_SESSION_STATE: ${{ secrets.IG_SESSION_STATE }}
        run: |
          if [ -n "$IG_SESSION_STATE" ]; then
            mkdir -p ~/.instagram
            echo "$IG_SESSION_STATE" | base64 -d > ~/.instagram/session.json
            chmod 600 ~/.instagram/session.json
            echo "‚úÖ Instagram session configured"
          else
            echo "‚ö†Ô∏è Instagram session not configured (will login with password)"
          fi

      - name: Create .env file
        run: |
          cat << EOF > .env
          # Data Collection APIs
          FINNHUB_API_KEY=${{ secrets.FINNHUB_API_KEY }}
          FRED_API_KEY=${{ secrets.FRED_API_KEY }}
          ALPHA_VANTAGE_API_KEY=${{ secrets.ALPHA_VANTAGE_API_KEY }}
          SEC_USER_AGENT=${{ secrets.SEC_USER_AGENT }}
          SEC_SYMBOLS=${{ secrets.SEC_SYMBOLS }}
          SEC_FORMS=${{ secrets.SEC_FORMS }}
          SEC_DAYS_BACK=${{ secrets.SEC_DAYS_BACK }}

          # Smart Money Data APIs (Optional)
          STOCKGEIST_API_KEY=${{ secrets.STOCKGEIST_API_KEY }}
          CONGRESS_DAYS_BACK=${{ secrets.CONGRESS_DAYS_BACK }}

          # LLM Configuration
          LLM_ENABLED=${{ secrets.LLM_ENABLED }}
          LLM_PROVIDER=${{ secrets.LLM_PROVIDER }}
          LLM_MODEL=${{ secrets.LLM_MODEL }}
          LLM_API_KEY=${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL=${{ secrets.LLM_BASE_URL }}
          LLM_TEMPERATURE=${{ secrets.LLM_TEMPERATURE }}
          LLM_MAX_TOKENS=${{ secrets.LLM_MAX_TOKENS }}
          LLM_TIMEOUT=${{ secrets.LLM_TIMEOUT }}

          # Email Configuration
          EMAIL_ENABLED=${{ secrets.EMAIL_ENABLED }}
          EMAIL_TO=${{ secrets.EMAIL_TO }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          EMAIL_SMTP_HOST=${{ secrets.EMAIL_SMTP_HOST }}
          EMAIL_SMTP_PORT=${{ secrets.EMAIL_SMTP_PORT }}
          EMAIL_SMTP_USER=${{ secrets.EMAIL_SMTP_USER }}
          EMAIL_SMTP_PASS=${{ secrets.EMAIL_SMTP_PASS }}

          # Telegram Configuration
          TELEGRAM_ENABLED=${{ secrets.TELEGRAM_ENABLED }}
          TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}

          # Instagram Configuration
          IG_ENABLED=${{ secrets.IG_ENABLED }}
          IG_USERNAME=${{ secrets.IG_USERNAME }}
          IG_PASSWORD=${{ secrets.IG_PASSWORD }}
          EOF

      - name: Collect market data
        run: npm run collect
        continue-on-error: false

      - name: Analyze data
        run: npm run analyze
        continue-on-error: false

      - name: Generate professional briefing
        run: npm run generate:pro
        continue-on-error: false

      - name: Generate NotebookLM infographic
        run: npm run generate:nlm-infographic
        continue-on-error: true

      - name: Generate NotebookLM slides
        run: npm run generate:nlm-slides
        continue-on-error: true

      - name: Send email (with infographic and slides)
        run: npm run send-email

      - name: Send Telegram
        run: npm run send-telegram

      - name: Post to Instagram
        run: npm run send-instagram
        continue-on-error: true

      - name: Save Instagram session for next run
        if: always()
        run: |
          if [ -f ~/.instagram/session.json ]; then
            cp ~/.instagram/session.json output/ig-session.json 2>/dev/null || true
            echo "‚úÖ Instagram session saved to artifact"
            echo "üí° To update IG_SESSION_STATE secret, run:"
            echo "   base64 < output/ig-session.json | pbcopy"
          fi

      - name: Upload briefing as artifact
        uses: actions/upload-artifact@v4
        with:
          name: briefing-${{ github.run_id }}
          path: output/
          retention-days: 30

      - name: Summary
        run: |
          echo "## Daily Briefing Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f output/ai-briefing-*.md ]; then
            echo "### Briefing Preview (first 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```markdown' >> $GITHUB_STEP_SUMMARY
            head -50 output/ai-briefing-*.md >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
